{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-truck me-2"></i>
                    Enregistrement de Livraison Fournisseur
                </h4>
            </div>
            <div class="card-body">
                <!-- Messages d'erreur/succès -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {% if message.tags == 'error' %}
                                <i class="fas fa-exclamation-triangle me-2"></i>
                            {% elif message.tags == 'success' %}
                                <i class="fas fa-check-circle me-2"></i>
                            {% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                <form method="post" id="livraisonForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_numero_enregistrement" class="form-label">N° d'enregistrement *</label>
                                <input type="text" class="form-control" id="id_numero_enregistrement" name="numero_enregistrement" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_date" class="form-label">Date de livraison *</label>
                                <input type="date" class="form-control" id="id_date" name="date" value="{{ today }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_fournisseur" class="form-label">Fournisseur *</label>
                                <div class="input-group">
                                    <select class="form-select" id="id_fournisseur" name="fournisseur" required>
                                        <option value="">Sélectionner un fournisseur</option>
                                        {% for fournisseur in fournisseurs %}
                                            <option value="{{ fournisseur.id }}">{{ fournisseur.nom }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" id="btnNouveauFournisseur" title="Ajouter un nouveau fournisseur">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small>Cliquez sur + pour ajouter un nouveau fournisseur</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_produit" class="form-label">Produit livré *</label>
                                <div class="input-group">
                                    <select class="form-select" id="id_produit" name="produit" required>
                                        <option value="">Sélectionner un produit</option>
                                        {% for produit in produits %}
                                            <option value="{{ produit.id }}">{{ produit.nom }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-warning" id="btnNouveauProduit" title="Ajouter un nouveau produit">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small>Cliquez sur + pour ajouter un nouveau produit</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_quantite_livree" class="form-label">Quantité livrée *</label>
                                <input type="number" step="0.01" class="form-control" id="id_quantite_livree" name="quantite_livree" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_prix_achat_unitaire" class="form-label">Prix d'achat unitaire *</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="id_prix_achat_unitaire" name="prix_achat_unitaire" required>
                                    <span class="input-group-text">GNF</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_montant_total" class="form-label">Montant total d'achat</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="id_montant_total" name="montant_total_achat" readonly>
                                    <span class="input-group-text">GNF</span>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">Calculé automatiquement</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_observations" class="form-label">Observations</label>
                        <textarea class="form-control" id="id_observations" name="observations" rows="3" placeholder="Observations sur la livraison..."></textarea>
                    </div>
                    
                    <!-- Récapitulatif de la livraison -->
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Récapitulatif de la livraison</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Quantité livrée:</span>
                                        <span id="recap-quantite">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Prix unitaire:</span>
                                        <span id="recap-prix">0 GNF</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>Montant total:</strong>
                                        <strong id="recap-total" class="text-primary">0 GNF</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'fournisseurs:livraison_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Retour
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>
                            Enregistrer la livraison
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour créer un nouveau fournisseur -->
<div class="modal fade" id="modalNouveauFournisseur" tabindex="-1" aria-labelledby="modalNouveauFournisseurLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNouveauFournisseurLabel">
                    <i class="fas fa-truck me-2"></i>
                    Nouveau Fournisseur
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNouveauFournisseur">
                    <div class="mb-3">
                        <label for="nouveau_fournisseur_nom" class="form-label">Nom du fournisseur *</label>
                        <input type="text" class="form-control" id="nouveau_fournisseur_nom" name="nom" required>
                    </div>
                    <div class="mb-3">
                        <label for="nouveau_fournisseur_telephone" class="form-label">Téléphone</label>
                        <input type="tel" class="form-control" id="nouveau_fournisseur_telephone" name="telephone">
                    </div>
                    <div class="mb-3">
                        <label for="nouveau_fournisseur_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="nouveau_fournisseur_email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="nouveau_fournisseur_adresse" class="form-label">Adresse</label>
                        <textarea class="form-control" id="nouveau_fournisseur_adresse" name="adresse" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="btnSauvegarderFournisseur">
                    <i class="fas fa-save me-2"></i>
                    Créer le fournisseur
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour créer un nouveau produit -->
<div class="modal fade" id="modalNouveauProduit" tabindex="-1" aria-labelledby="modalNouveauProduitLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNouveauProduitLabel">
                    <i class="fas fa-box me-2"></i>
                    Nouveau Produit
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNouveauProduit">
                    <div class="mb-3">
                        <label for="nouveau_produit_nom" class="form-label">Nom du produit *</label>
                        <input type="text" class="form-control" id="nouveau_produit_nom" name="nom" required>
                    </div>
                    <div class="mb-3">
                        <label for="nouveau_produit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="nouveau_produit_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nouveau_produit_unite" class="form-label">Unité de mesure</label>
                                <select class="form-select" id="nouveau_produit_unite" name="unite_mesure">
                                    <option value="pièce">Pièce</option>
                                    <option value="kg">Kilogramme</option>
                                    <option value="litre">Litre</option>
                                    <option value="mètre">Mètre</option>
                                    <option value="carton">Carton</option>
                                    <option value="sac">Sac</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nouveau_produit_prix_vente" class="form-label">Prix de vente conseillé</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="nouveau_produit_prix_vente" name="prix_vente_conseille">
                                    <span class="input-group-text">GNF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="btnSauvegarderProduit">
                    <i class="fas fa-save me-2"></i>
                    Créer le produit
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fonction pour calculer le montant total automatiquement
function calculerMontantTotal() {
    const quantite = parseFloat(document.getElementById('id_quantite_livree').value) || 0;
    const prixUnitaire = parseFloat(document.getElementById('id_prix_achat_unitaire').value) || 0;
    const montantTotal = quantite * prixUnitaire;
    
    // Mettre à jour le champ montant total
    document.getElementById('id_montant_total').value = montantTotal.toFixed(2);
    
    // Mettre à jour le récapitulatif
    document.getElementById('recap-quantite').textContent = quantite.toLocaleString();
    document.getElementById('recap-prix').textContent = prixUnitaire.toLocaleString() + ' GNF';
    document.getElementById('recap-total').textContent = montantTotal.toLocaleString() + ' GNF';
}

// Événements pour le calcul automatique du montant total en temps réel
document.getElementById('id_quantite_livree').addEventListener('input', calculerMontantTotal);
document.getElementById('id_quantite_livree').addEventListener('keyup', calculerMontantTotal);
document.getElementById('id_quantite_livree').addEventListener('change', calculerMontantTotal);

document.getElementById('id_prix_achat_unitaire').addEventListener('input', calculerMontantTotal);
document.getElementById('id_prix_achat_unitaire').addEventListener('keyup', calculerMontantTotal);
document.getElementById('id_prix_achat_unitaire').addEventListener('change', calculerMontantTotal);

// Gestion du modal nouveau fournisseur
document.getElementById('btnNouveauFournisseur').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalNouveauFournisseur'));
    modal.show();
});

document.getElementById('btnSauvegarderFournisseur').addEventListener('click', function() {
    const nom = document.getElementById('nouveau_fournisseur_nom').value.trim();
    const telephone = document.getElementById('nouveau_fournisseur_telephone').value.trim();
    const email = document.getElementById('nouveau_fournisseur_email').value.trim();
    const adresse = document.getElementById('nouveau_fournisseur_adresse').value.trim();
    
    if (!nom) {
        alert('Le nom du fournisseur est obligatoire.');
        return;
    }
    
    // Créer une nouvelle option dans le select
    const select = document.getElementById('id_fournisseur');
    const newId = 'new_fournisseur_' + Date.now();
    const option = new Option(nom, newId, true, true);
    select.add(option);
    
    // Fermer le modal et réinitialiser le formulaire
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalNouveauFournisseur'));
    modal.hide();
    document.getElementById('formNouveauFournisseur').reset();
    
    // Afficher un message de succès
    showSuccessMessage('Fournisseur "' + nom + '" créé avec succès !');
});

// Gestion du modal nouveau produit
document.getElementById('btnNouveauProduit').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalNouveauProduit'));
    modal.show();
});

document.getElementById('btnSauvegarderProduit').addEventListener('click', function() {
    const nom = document.getElementById('nouveau_produit_nom').value.trim();
    const description = document.getElementById('nouveau_produit_description').value.trim();
    const unite = document.getElementById('nouveau_produit_unite').value;
    const prixVente = document.getElementById('nouveau_produit_prix_vente').value;
    
    if (!nom) {
        alert('Le nom du produit est obligatoire.');
        return;
    }
    
    // Créer une nouvelle option dans le select
    const select = document.getElementById('id_produit');
    const newId = 'new_product_' + Date.now();
    const option = new Option(nom, newId, true, true);
    select.add(option);
    
    // Fermer le modal et réinitialiser le formulaire
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalNouveauProduit'));
    modal.hide();
    document.getElementById('formNouveauProduit').reset();
    
    // Afficher un message de succès
    showSuccessMessage('Produit "' + nom + '" créé avec succès !');
});

// Fonction pour afficher un message de succès
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insérer l'alerte au début du card-body
    const cardBody = document.querySelector('.card-body');
    cardBody.insertBefore(alertDiv, cardBody.firstChild);
    
    // Supprimer l'alerte après 5 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Validation du formulaire avant soumission
document.getElementById('livraisonForm').addEventListener('submit', function(e) {
    const requiredFields = document.querySelectorAll('[required]');
    let allValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            allValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!allValid) {
        e.preventDefault();
        alert('Veuillez remplir tous les champs obligatoires.');
    }
});

// Calcul initial au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    calculerMontantTotal();
});
</script>
{% endblock %}
