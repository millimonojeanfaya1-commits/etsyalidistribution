{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h4 class="mb-0">
          <i class="fas fa-file-invoice-dollar me-2"></i>
          {{ title }}
        </h4>
        <a href="{% url 'credits:credit_list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-list me-1"></i> Liste des crédits
        </a>
      </div>
      <div class="card-body">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {% if message.tags == 'error' %}
                <i class="fas fa-exclamation-triangle me-2"></i>
              {% elif message.tags == 'success' %}
                <i class="fas fa-check-circle me-2"></i>
              {% endif %}
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
        <div id="alert-magasin" class="alert alert-info d-none" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          Veuillez d’abord sélectionner un <strong>magasin</strong> pour charger la liste des produits disponibles.
        </div>

        <form method="post" id="creditForm" novalidate>
          {% csrf_token %}
          {{ form|crispy }}

          <div class="d-flex justify-content-between mt-3">
            <a href="{% url 'credits:credit_list' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i> Retour
            </a>
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-save me-2"></i> Enregistrer le crédit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Champs
    const numero = document.getElementById('id_numero');
    const dateEl = document.getElementById('id_date');
    const quantite = document.getElementById('id_quantite');
    const prix = document.getElementById('id_prix_unitaire');

    // Définir la date max = aujourd'hui
    if (dateEl) {
      const today = new Date().toISOString().split('T')[0];
      if (!dateEl.value) dateEl.value = today;
      dateEl.setAttribute('max', today);
    }

    // Pattern pour le numéro (ex: CRD0001)
    if (numero) {
      numero.setAttribute('pattern', '^CRD\\\d{4,}$');
      numero.setAttribute('title', 'Format attendu: CRD0001');
    }

    // Min/step pour quantite et prix (entiers uniquement)
    if (quantite) { quantite.setAttribute('min', '1'); quantite.setAttribute('step', '1'); }
    if (prix) { prix.setAttribute('min', '1'); prix.setAttribute('step', '1'); }

    // Dépendance: charger les produits selon le magasin sélectionné
    const magasin = document.getElementById('id_magasin');
    const produit = document.getElementById('id_produit');
    const alertMagasin = document.getElementById('alert-magasin');

    function updateAlertMagasin() {
      if (!alertMagasin || !magasin) return;
      const show = !magasin.value;
      alertMagasin.classList.toggle('d-none', !show);
    }

    function resetProduits(placeholder='— Sélectionner un produit —') {
      if (!produit) return;
      produit.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder;
      produit.appendChild(opt);
      produit.value = '';
      produit.disabled = true;
    }

    async function chargerProduits(magasinId) {
      if (!produit) return;
      resetProduits('Chargement...');
      try {
        const url = `${window.location.origin}{% url 'credits:produits_par_magasin' 0 %}`.replace('/0/', `/${magasinId}/`);
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const data = await resp.json();
        produit.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '— Sélectionner un produit —';
        produit.appendChild(placeholder);
        (data.produits || []).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.nom;
          produit.appendChild(opt);
        });
        produit.disabled = false;
      } catch (e) {
        resetProduits('Aucun produit disponible');
      }
    }

    if (magasin && produit) {
      // Si aucun magasin sélectionné au chargement, tenter de sélectionner le premier disponible
      if (!magasin.value) {
        const firstOption = Array.from(magasin.options).find(o => o.value);
        if (firstOption) {
          magasin.value = firstOption.value;
        }
      }
      if (!magasin.value) {
        resetProduits();
      } else {
        // Initialiser la liste si un magasin est présent (auto-sélectionné ou retour validation)
        chargerProduits(magasin.value).then(() => {
          // Conserver la valeur existante si présente
          if (produit.getAttribute('data-initial')) {
            produit.value = produit.getAttribute('data-initial');
          }
        });
      }
      magasin.addEventListener('change', function() {
        const mid = this.value;
        if (mid) {
          chargerProduits(mid);
        } else {
          resetProduits();
        }
        updateAlertMagasin();
      });
      // Initial toggle
      updateAlertMagasin();
    }

    // Validation simple avant soumission
    const form = document.getElementById('creditForm');
    form.addEventListener('submit', function(e) {
      let valid = true;

      if (numero && !/^CRD\d{4,}$/.test((numero.value || '').trim())) {
        numero.classList.add('is-invalid');
        valid = false;
      } else if (numero) {
        numero.classList.remove('is-invalid');
      }

      if (dateEl) {
        const today = new Date().toISOString().split('T')[0];
        if (dateEl.value > today) {
          dateEl.classList.add('is-invalid');
          valid = false;
        } else {
          dateEl.classList.remove('is-invalid');
        }
      }

      const q = parseInt(quantite ? quantite.value : '0', 10) || 0;
      const p = parseInt(prix ? prix.value : '0', 10) || 0;
      if (quantite && !(q > 0)) { quantite.classList.add('is-invalid'); valid = false; } else if (quantite) { quantite.classList.remove('is-invalid'); }
      if (prix && !(p > 0)) { prix.classList.add('is-invalid'); valid = false; } else if (prix) { prix.classList.remove('is-invalid'); }

      if (!valid) {
        e.preventDefault();
      }
    });
  });
</script>
{% endblock %}
